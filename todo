Fix shadowing bugs, replace HashMap in lookup with smth else
